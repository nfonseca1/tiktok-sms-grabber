<!DOCTYPE html>
<html>
    <head>
        <title></title>
        <style>
            body {
                background-color: #202020;
                color: #d0d0d0;
            }
        </style>
    </head>
    <body>
        <input type="text" placeholder="Contact to search" id="contact">
        is 
        <input type="text" placeholder="Contact username (optional)" id="username">
        <button>Get Videos</button>
        <br>
        <div class="content">
            
        </div>
        <script>
            let contact = document.querySelector("#contact");
            let username = document.querySelector("#username");
            let btn = document.querySelector("button");
            let content = document.querySelector(".content");
            let postIndex = 0;

            checkStatus(true);

            btn.addEventListener("click", async () => {
                if (contact.value === "") return;
                fetch("/home", {
                    method: "POST",
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify({contact: contact.value, username: username.value})
                })
                .then(res => {
                    return res.json();
                })
                .then(data => {
                    if (data.authenticate) {
                        content.innerHTML = "<img src='/qr.png'>";
                    }

                    window.interval;
                    interval = setInterval((interval) => {
                        checkStatus(interval);
                    }, 5000);
                })
            })

            async function checkStatus(grabDefault = false) {
                let response = await fetch("/status", {
                    method: "post",
                    headers: {
                        'Content-type': 'application/json'
                    },
                    body: JSON.stringify({grabDefault: grabDefault}),
                });
                let data = await response.json();
                if (data.posts.length === 0) return;
                for (let i = postIndex; i < data.posts.length; i++) {
                    let div = document.createElement("div");
                    div.innerHTML = data.posts[i].html;
                    let script = document.createElement("script");
                    let src = document.createAttribute("src");
                    src.value = "https://www.tiktok.com/embed.js";
                    script.setAttributeNode(src);
                    div.appendChild(script);
                    document.querySelector("body").appendChild(div);
                }
                window.postIndex = data.posts.length;
                if (data.completed && interval) clearInterval(interval);
            }
        </script>
    </body>
</html>